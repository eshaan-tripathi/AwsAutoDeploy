name: üöÄ Deploy AWS Service

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      TF_LOG: ERROR
      TF_INPUT: false
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Load service config
        id: load-config
        run: |
          set -e
          SERVICE_NAME=$(jq -r '.service_name' service.json)
          SERVICE_TYPE=$(jq -r '.service_type' service.json)
          AWS_REGION=$(jq -r '.aws_region' service.json)

          echo "SERVICE_NAME=$SERVICE_NAME" >> $GITHUB_ENV
          echo "SERVICE_TYPE=$SERVICE_TYPE" >> $GITHUB_ENV
          echo "AWS_REGION=$AWS_REGION" >> $GITHUB_ENV
          echo "‚úÖ Loaded config: $SERVICE_NAME ($SERVICE_TYPE) in $AWS_REGION"

      - name: Install dependencies
        run: |
          set -e
          npm install

      - name: Check JavaScript Syntax
        run: |
          set -e
          npx eslint src/**/*.js tests/**/*.js --max-warnings=0

      - name: Run Tests
        run: |
          set -e
          npm test

      - name: Package source code
        run: |
          set -e
          cd src
          zip -r ../auto-deploy.zip . -x "node_modules/*" "*.test.js"
          cd ..
          echo "‚úÖ Code packaged successfully"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.2

      - name: Terraform Init
        run: |
          set -e
          cd terraform
          terraform init -input=false

      - name: Import Existing AWS Resource
        run: |
          set -e
          cd terraform
          case "$SERVICE_TYPE" in
            lambda)
              if aws lambda get-function --function-name "$SERVICE_NAME" >/dev/null 2>&1; then
                terraform import -var="service_name=$SERVICE_NAME" -var="service_type=$SERVICE_TYPE" aws_lambda_function.this "$SERVICE_NAME"
              fi
              ;;
            s3)
              if aws s3api head-bucket --bucket "$SERVICE_NAME" >/dev/null 2>&1; then
                terraform import -var="service_name=$SERVICE_NAME" -var="service_type=$SERVICE_TYPE" aws_s3_bucket.this "$SERVICE_NAME"
              fi
              ;;
            glue)
              if aws glue get-job --job-name "$SERVICE_NAME" >/dev/null 2>&1; then
                terraform import -var="service_name=$SERVICE_NAME" -var="service_type=$SERVICE_TYPE" aws_glue_job.this "$SERVICE_NAME"
              fi
              ;;
            ec2)
              echo "Skipping EC2 import ‚Äî handled by Terraform configuration."
              ;;
          esac

      - name: Terraform Validate
        run: |
          set -e
          cd terraform
          terraform validate

      - name: Terraform Plan
        run: |
          set -e
          cd terraform
          terraform plan -input=false -var="service_name=$SERVICE_NAME" -var="service_type=$SERVICE_TYPE"

      - name: Terraform Apply with Rollback
        run: |
          set -e
          cd terraform
          if ! terraform apply -auto-approve -input=false -var="service_name=$SERVICE_NAME" -var="service_type=$SERVICE_TYPE"; then
            echo "‚ùå Terraform apply failed! Rolling back..."
            terraform destroy -auto-approve -var="service_name=$SERVICE_NAME" -var="service_type=$SERVICE_TYPE"
            exit 1
          fi

      - name: Verify Deployment
        run: |
          set -e
          case "$SERVICE_TYPE" in
            lambda)
              aws lambda get-function --function-name "$SERVICE_NAME"
              ;;
            s3)
              aws s3api head-bucket --bucket "$SERVICE_NAME"
              ;;
            glue)
              aws glue get-job --job-name "$SERVICE_NAME"
              ;;
            ec2)
              echo "Verify EC2 instance with Terraform outputs."
              ;;
          esac
          echo "‚úÖ Deployment verified successfully!"
